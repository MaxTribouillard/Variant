<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <title>Variant AR Debug</title>

  <!-- Variant SDK -->
  <script src="https://launchar.app/sdk/v1?key=6a59320Dz0LvGovw5MBH0PZvLkDqJt8X&redirect=true"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      width: 100vw;
      height: 100vh;
      display: block;
    }
  </style>
</head>

<body>

<canvas id="xr-canvas"></canvas>

<!-- üü© CONSOLE VISUELLE POUR IPHONE -->
<script>
(function() {
  const logBox = document.createElement("div");
  logBox.style.position = "fixed";
  logBox.style.bottom = "0";
  logBox.style.left = "0";
  logBox.style.width = "100%";
  logBox.style.maxHeight = "50vh";
  logBox.style.background = "rgba(0,0,0,0.85)";
  logBox.style.color = "#0f0";
  logBox.style.fontSize = "12px";
  logBox.style.overflowY = "auto";
  logBox.style.padding = "10px";
  logBox.style.zIndex = "999999";
  logBox.style.fontFamily = "monospace";
  document.body.appendChild(logBox);

  const print = (...args) => {
    logBox.innerHTML += args.join(" ") + "<br>";
    logBox.scrollTop = logBox.scrollHeight;
  };

  const originalLog = console.log;
  const originalErr = console.error;
  const originalWarn = console.warn;

  console.log = (...args) => { originalLog(...args); print("[LOG]", ...args); };
  console.error = (...args) => { originalErr(...args); print("[ERR]", ...args); };
  console.warn = (...args) => { originalWarn(...args); print("[WARN]", ...args); };

  window.onerror = function (msg, url, lineNo, columnNo, error) {
    print("[ONERROR]", msg, "line:", lineNo, "col:", columnNo);
  };

  console.log("üì¢ Console visuelle pr√™te !");
})();
</script>

<script>
console.log("üìÇ Script AR charg√©");

// ‚ö†Ô∏è Variant appelle cette fonction automatiquement quand WebXR est pr√™t
window.launch_ready = async () => {
  console.log("üöÄ launch_ready d√©clench√© (Variant pr√™t)");

  // V√©rifier si WebXR a √©t√© inject√©
  if (!navigator.xr) {
    console.error("‚ùå navigator.xr est NULL ‚Üí WebXR non inject√©");
    console.error("üëâ Soit Variant n‚Äôa pas d√©marr√©, soit l‚ÄôApp Clip n‚Äôa pas √©t√© lanc√©");
    return;
  }

  console.log("‚úÖ navigator.xr d√©tect√©");

  try {
    console.log("üì° Demande de session immersive-ar‚Ä¶");

    const session = await navigator.xr.requestSession("immersive-ar", {
      requiredFeatures: ["local", "hit-test", "anchors"],
    });

    console.log("üü¢ Session AR d√©marr√©e !");

    const canvas = document.getElementById("xr-canvas");

    // Initialisation WebGL compatible XR
    console.log("üé® Initialisation WebGL‚Ä¶");
    const gl = canvas.getContext("webgl", { xrCompatible: true });

    if (!gl) {
      console.error("‚ùå Impossible d‚Äôobtenir un contexte WebGL !");
      return;
    }

    console.log("‚úÖ WebGL OK");

    await gl.makeXRCompatible();
    console.log("üéØ XR compatible OK");

    session.updateRenderState({
      baseLayer: new XRWebGLLayer(session, gl),
    });

    console.log("üß≠ Demande du referenceSpace‚Ä¶");

    const referenceSpace = await session.requestReferenceSpace("local");
    console.log("üìå referenceSpace OK");

    // üîÅ LOOP XR
    const onXRFrame = (time, frame) => {
      const pose = frame.getViewerPose(referenceSpace);

      if (!pose) {
        console.warn("‚ö†Ô∏è Aucun viewer pose (pas encore suivi)");
      }

      const glLayer = session.renderState.baseLayer;
      gl.bindFramebuffer(gl.FRAMEBUFFER, glLayer.framebuffer);

      gl.clearColor(0, 0, 0, 0);
      gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

      session.requestAnimationFrame(onXRFrame);
    };

    console.log("üé¨ D√©marrage du render loop");
    session.requestAnimationFrame(onXRFrame);

  } catch (err) {
    console.error("üí• ERREUR requestSession :", err);
  }
};
</script>

</body>
</html>
